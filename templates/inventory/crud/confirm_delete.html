{% extends "base.html" %}
{% block title %}{{ title }} – Учёт картриджей{% endblock %}

{% block content %}
<h1 class="h5 mb-3">{{ title }}</h1>

<div class="card shadow-sm">
  <div class="card-body">

    <p class="mb-4">
      {% if can_delete %}
        Удалить {{ delete_kind }}: <span class="fw-semibold">{{ delete_subject }}</span>?
      {% else %}
        Удаление невозможно: <span class="fw-semibold">{{ delete_subject }}</span>
      {% endif %}
    </p>

    <div class="d-flex gap-2 flex-wrap">
      {% if can_delete %}
        <button class="btn btn-danger" type="button" data-bs-toggle="modal" data-bs-target="#confirmDeleteModal">
          <i class="bi bi-trash"></i>
          Удалить
        </button>
      {% else %}
        <button class="btn btn-outline-secondary" type="button" data-bs-toggle="modal" data-bs-target="#confirmDeleteModal">
          <i class="bi bi-info-circle"></i>
          Почему нельзя удалить?
        </button>
      {% endif %}
      <a class="btn btn-outline-secondary" href="javascript:history.back()">Назад</a>
    </div>

    {# Реальная форма удаления (отправится из модалки), только если можно удалить #}
    {% if can_delete %}
      <form id="deleteForm" method="post" class="d-none">
        {% csrf_token %}
      </form>
    {% endif %}

  </div>
</div>

{# ===== Модальное окно ===== #}
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title" id="confirmDeleteModalLabel">
          {% if can_delete %}Подтверждение удаления{% else %}Удаление невозможно{% endif %}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
      </div>

      <div class="modal-body">

        {% if can_delete %}
          <div class="mb-2">
            Вы действительно хотите удалить {{ delete_kind }}
            <span class="fw-semibold">{{ delete_subject }}</span>?
          </div>

          <div class="alert alert-danger mb-0" role="alert">
            <div class="fw-semibold mb-2">
              Последствия
            </div>
            <ul class="mb-0 ps-3">
              {% for line in consequences %}
                <li>{{ line }}</li>
              {% endfor %}
            </ul>
          </div>

        {% else %}
          <div class="mb-2">
            {{ delete_kind|capfirst }} <span class="fw-semibold">{{ delete_subject }}</span> нельзя удалить.
          </div>

          <div class="alert alert-warning mb-0" role="alert">
            <div class="fw-semibold mb-2">
              Причины и что делать
            </div>

            {% for b in blockers %}
              <div class="{% if not forloop.first %}mt-3{% endif %}">
                <div class="fw-semibold">{{ b.title }}</div>
                <div class="small">{{ b.details }}</div>
                {% if b.actions %}
                  <ul class="small mb-0 ps-3 mt-2">
                    {% for a in b.actions %}
                      <li>{{ a }}</li>
                    {% endfor %}
                  </ul>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        {% endif %}
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
          Закрыть
        </button>

        {% if can_delete %}
          <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
            Да, удалить
          </button>
        {% endif %}
      </div>

    </div>
  </div>
</div>

{% if can_delete %}
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const btn = document.getElementById("confirmDeleteBtn");
    const form = document.getElementById("deleteForm");
    if (btn && form) {
      btn.addEventListener("click", () => form.submit());
    }
  });
</script>
{% endif %}
{% endblock %}